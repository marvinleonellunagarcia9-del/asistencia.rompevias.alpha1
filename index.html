<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control de Asistencia</title>
    
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para compilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Ajustes para dispositivos móviles */
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
          .pb-safe { padding-bottom: calc(0.5rem + env(safe-area-inset-bottom)); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const { useState, useEffect } = React;

        // --- CONFIGURACIÓN DE BASE DE DATOS ---
        // Si publicas esto en GitHub, la app funcionará en MODO LOCAL por defecto.
        // Si quieres que varias personas sincronicen datos en la nube, reemplaza "null" con la configuración de tu propio proyecto Firebase.
        const MI_PROPIA_BASE_DE_DATOS = null; 
        // Ejemplo: const MI_PROPIA_BASE_DE_DATOS = { apiKey: "AIza...", projectId: "mi-app", ... };

        let app, auth, db, appId;
        try {
            if (MI_PROPIA_BASE_DE_DATOS) {
                app = initializeApp(MI_PROPIA_BASE_DE_DATOS);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = 'mi-app-propia';
            } else if (typeof __firebase_config !== 'undefined') {
                const firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            }
        } catch (error) {
            console.error("No hay nube disponible, operando en modo local.");
        }

        // --- ICONOS SVG ---
        const IconUsers = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const IconCalendar = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>;
        const IconCheckSquare = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>;
        const IconFileText = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" x2="8" y1="13" y2="13"></line><line x1="16" x2="8" y1="17" y2="17"></line><line x1="10" x2="8" y1="9" y2="9"></line></svg>;
        const IconPlus = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>;
        const IconTrash2 = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>;
        const IconCheckCircle = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const IconXCircle = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="15" x2="9" y1="9" y2="15"></line><line x1="9" x2="15" y1="9" y2="15"></line></svg>;
        const IconAlertCircle = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" x2="12" y1="8" y2="12"></line><line x1="12" x2="12.01" y1="16" y2="16"></line></svg>;
        const IconUser = ({size=24, className=""}) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;

        function App() {
            // --- ESTADOS (Híbrido: LocalStorage por defecto, Firebase si hay conexión) ---
            const [user, setUser] = useState(null);
            
            // Inicializar con LocalStorage para que la app funcione inmediatamente en GitHub Pages
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('local_users')) || []);
            const [activities, setActivities] = useState(() => JSON.parse(localStorage.getItem('local_activities')) || []);
            const [attendance, setAttendance] = useState(() => JSON.parse(localStorage.getItem('local_attendance')) || {});
            
            const [loadingDb, setLoadingDb] = useState(!!db); // Solo carga si hay DB configurada
            const [isOnline, setIsOnline] = useState(false);
            
            const [activeTab, setActiveTab] = useState('users');
            const [notification, setNotification] = useState(null);

            // --- FORMULARIOS ---
            const [userForm, setUserForm] = useState({ fullName: '', age: '', idNumber: '', address: '', phone: '', email: '', photo: null });
            const [activityForm, setActivityForm] = useState({ name: '', date: '' });
            const [selectedActivityForAttendance, setSelectedActivityForAttendance] = useState('');
            const [selectedActivityForReport, setSelectedActivityForReport] = useState('');

            // Sincronización LocalStorage constante
            useEffect(() => { if (!isOnline) localStorage.setItem('local_users', JSON.stringify(users)); }, [users, isOnline]);
            useEffect(() => { if (!isOnline) localStorage.setItem('local_activities', JSON.stringify(activities)); }, [activities, isOnline]);
            useEffect(() => { if (!isOnline) localStorage.setItem('local_attendance', JSON.stringify(attendance)); }, [attendance, isOnline]);

            // --- FIREBASE EFECTOS ---
            useEffect(() => {
                if (!auth) {
                    setLoadingDb(false);
                    return;
                }
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (err) {
                        console.error("Error de Autenticación:", err);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                setIsOnline(true);
                
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const activitiesRef = collection(db, 'artifacts', appId, 'public', 'data', 'activities');
                const attendanceRef = collection(db, 'artifacts', appId, 'public', 'data', 'attendance');

                const unsubUsers = onSnapshot(usersRef, (snap) => {
                    setUsers(snap.docs.map(d => ({ ...d.data(), id: d.id })));
                    setLoadingDb(false);
                }, console.error);

                const unsubActivities = onSnapshot(activitiesRef, (snap) => {
                    setActivities(snap.docs.map(d => ({ ...d.data(), id: d.id })));
                }, console.error);

                const unsubAttendance = onSnapshot(attendanceRef, (snap) => {
                    const attData = {};
                    snap.docs.forEach(d => { attData[d.id] = d.data(); });
                    setAttendance(attData);
                }, console.error);

                return () => { unsubUsers(); unsubActivities(); unsubAttendance(); };
            }, [user]);

            // --- FUNCIONES AUXILIARES ---
            const showNotification = (msg, type = 'success') => {
                setNotification({ msg, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const generateId = () => Math.random().toString(36).substr(2, 9);

            const handlePhotoChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 1000000) {
                        showNotification('La imagen es muy grande (Máx 1MB)', 'error');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onloadend = () => setUserForm(prev => ({ ...prev, photo: reader.result }));
                    reader.readAsDataURL(file);
                }
            };

            // --- ACCIONES (Guardan en DB si está activa, si no en Memoria Local) ---
            const handleAddUser = async (e) => {
                e.preventDefault();
                if (!userForm.fullName || !userForm.idNumber) {
                    showNotification('El nombre y la identificación son obligatorios', 'error');
                    return;
                }
                const id = generateId();
                const newUser = { ...userForm, id };
                
                if (isOnline && db) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), newUser);
                } else {
                    setUsers(prev => [...prev, newUser]);
                }
                
                setUserForm({ fullName: '', age: '', idNumber: '', address: '', phone: '', email: '', photo: null });
                const photoInput = document.getElementById('photoInput');
                if (photoInput) photoInput.value = '';
                showNotification('Usuario registrado exitosamente');
            };

            const handleDeleteUser = async (id) => {
                if (confirm('¿Seguro que deseas eliminar este usuario?')) {
                    if (isOnline && db) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id));
                    } else {
                        setUsers(prev => prev.filter(u => u.id !== id));
                    }
                    showNotification('Usuario eliminado');
                }
            };

            const handleAddActivity = async (e) => {
                e.preventDefault();
                if (!activityForm.name || !activityForm.date) {
                    showNotification('El nombre y la fecha son obligatorios', 'error');
                    return;
                }
                const id = generateId();
                const newActivity = { ...activityForm, id };
                
                if (isOnline && db) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'activities', id), newActivity);
                } else {
                    setActivities(prev => [...prev, newActivity]);
                }
                setActivityForm({ name: '', date: '' });
                showNotification('Actividad programada');
            };

            const toggleAttendance = async (activityId, userId) => {
                const currentStatus = attendance[activityId]?.[userId] || false;
                
                if (isOnline && db) {
                    await setDoc(
                        doc(db, 'artifacts', appId, 'public', 'data', 'attendance', activityId),
                        { [userId]: !currentStatus },
                        { merge: true }
                    );
                } else {
                    setAttendance(prev => ({
                        ...prev,
                        [activityId]: { ...(prev[activityId] || {}), [userId]: !currentStatus }
                    }));
                }
            };

            const markAll = async (activityId, status) => {
                const newStatus = {};
                users.forEach(u => { newStatus[u.id] = status; });
                
                if (isOnline && db) {
                    await setDoc(
                        doc(db, 'artifacts', appId, 'public', 'data', 'attendance', activityId),
                        newStatus,
                        { merge: true }
                    );
                } else {
                    setAttendance(prev => ({ ...prev, [activityId]: newStatus }));
                }
            };

            // --- VISTAS ---
            const renderNotification = () => {
                if (!notification) return null;
                return (
                    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-lg z-50 flex items-center space-x-2 w-11/12 max-w-md ${notification.type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : 'bg-green-100 text-green-800 border border-green-200'}`}>
                        {notification.type === 'error' ? <IconAlertCircle size={20} /> : <IconCheckCircle size={20} />}
                        <span className="font-medium">{notification.msg}</span>
                    </div>
                );
            };

            const renderUsersTab = () => (
                <div className="space-y-6 pb-20">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h2 className="text-xl font-bold text-slate-800 mb-4">Registrar Usuario</h2>
                        <form onSubmit={handleAddUser} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">Nombre Completo *</label>
                                <input type="text" value={userForm.fullName} onChange={e => setUserForm({...userForm, fullName: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej. Juan Pérez" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Edad</label>
                                    <input type="number" value={userForm.age} onChange={e => setUserForm({...userForm, age: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej. 25" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Identificación *</label>
                                    <input type="text" value={userForm.idNumber} onChange={e => setUserForm({...userForm, idNumber: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="DPI / Cédula" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">Dirección</label>
                                <textarea value={userForm.address} onChange={e => setUserForm({...userForm, address: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Teléfono</label>
                                    <input type="tel" value={userForm.phone} onChange={e => setUserForm({...userForm, phone: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej. 5555-5555" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Correo Electrónico</label>
                                    <input type="email" value={userForm.email} onChange={e => setUserForm({...userForm, email: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">Foto (Opcional - Máx 1MB)</label>
                                <input type="file" accept="image/*" onChange={handlePhotoChange} id="photoInput" className="w-full p-2 border border-slate-200 rounded-lg text-sm bg-slate-50 outline-none" />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold flex justify-center items-center space-x-2">
                                <IconPlus size={20} /> <span>Guardar Usuario</span>
                            </button>
                        </form>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div className="p-4 bg-slate-50 border-b border-slate-100">
                            <h3 className="font-bold text-slate-700">Usuarios en Sistema ({users.length})</h3>
                        </div>
                        <div className="divide-y divide-slate-100">
                            {users.length === 0 ? <p className="p-6 text-center text-slate-400">No hay usuarios registrados aún.</p> : users.map(user => (
                                <div key={user.id} className="p-4 flex justify-between items-center">
                                    <div className="flex items-center space-x-4">
                                        {user.photo ? <img src={user.photo} className="w-12 h-12 rounded-full object-cover border border-slate-200" /> : <div className="w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center text-slate-500"><IconUser size={24} /></div>}
                                        <div>
                                            <p className="font-semibold text-slate-800">{user.fullName}</p>
                                            <p className="text-sm text-slate-500">ID: {user.idNumber} | Tel: {user.phone || 'N/A'}</p>
                                        </div>
                                    </div>
                                    <button onClick={() => handleDeleteUser(user.id)} className="text-red-400 p-2 hover:text-red-600 transition-colors"><IconTrash2 size={20} /></button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            const renderActivitiesTab = () => (
                <div className="space-y-6 pb-20">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h2 className="text-xl font-bold text-slate-800 mb-4">Programar Actividad</h2>
                        <form onSubmit={handleAddActivity} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">Nombre *</label>
                                <input type="text" value={activityForm.name} onChange={e => setActivityForm({...activityForm, name: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">Fecha *</label>
                                <input type="date" value={activityForm.date} onChange={e => setActivityForm({...activityForm, date: e.target.value})} className="w-full p-3 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold flex justify-center items-center space-x-2">
                                <IconPlus size={20} /> <span>Crear Actividad</span>
                            </button>
                        </form>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div className="p-4 bg-slate-50 border-b border-slate-100"><h3 className="font-bold text-slate-700">Actividades ({activities.length})</h3></div>
                        <div className="divide-y divide-slate-100">
                            {activities.length === 0 ? <p className="p-6 text-center text-slate-400">No hay actividades.</p> : activities.map(act => (
                                <div key={act.id} className="p-4"><p className="font-semibold text-slate-800">{act.name}</p><p className="text-sm text-slate-500">{act.date}</p></div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            const renderAttendanceTab = () => (
                <div className="space-y-6 pb-20">
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h2 className="text-xl font-bold text-slate-800 mb-4">Tomar Asistencia</h2>
                        <select value={selectedActivityForAttendance} onChange={e => setSelectedActivityForAttendance(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg outline-none bg-white focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Selecciona una actividad --</option>
                            {activities.map(act => <option key={act.id} value={act.id}>{act.name} ({act.date})</option>)}
                        </select>
                        <p className="text-xs text-slate-400 mt-2 flex items-center">
                            {isOnline ? <><IconCheckCircle size={14} className="mr-1 text-green-500"/> Sincronizado en la nube</> : <><IconAlertCircle size={14} className="mr-1 text-yellow-500"/> Guardando localmente</>}
                        </p>
                    </div>

                    {selectedActivityForAttendance && users.length > 0 && (
                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div className="p-4 bg-slate-50 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                                <h3 className="font-bold text-slate-700">Lista de Usuarios</h3>
                                <div className="flex space-x-2 w-full sm:w-auto">
                                    <button onClick={() => markAll(selectedActivityForAttendance, true)} className="flex-1 text-xs bg-green-100 text-green-700 px-3 py-2 rounded-lg font-semibold">Marcar Todos</button>
                                    <button onClick={() => markAll(selectedActivityForAttendance, false)} className="flex-1 text-xs bg-red-100 text-red-700 px-3 py-2 rounded-lg font-semibold">Desmarcar Todos</button>
                                </div>
                            </div>
                            <div className="divide-y divide-slate-100">
                                {users.map(user => {
                                    const isPresent = attendance[selectedActivityForAttendance]?.[user.id] || false;
                                    return (
                                        <div key={user.id} className="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors" onClick={() => toggleAttendance(selectedActivityForAttendance, user.id)}>
                                            <div className="flex items-center space-x-3">
                                                {user.photo ? <img src={user.photo} className="w-10 h-10 rounded-full object-cover" /> : <div className="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-500"><IconUser size={20} /></div>}
                                                <div><p className="font-semibold text-slate-800">{user.fullName}</p><p className="text-sm text-slate-500">{user.idNumber}</p></div>
                                            </div>
                                            <div>
                                                {isPresent ? <div className="flex items-center text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-200 shadow-sm"><IconCheckCircle size={20} className="mr-1" /><span className="text-sm font-semibold">Presente</span></div> 
                                                : <div className="flex items-center text-slate-500 bg-white px-3 py-1 rounded-full border border-slate-300 shadow-sm"><IconXCircle size={20} className="mr-1" /><span className="text-sm font-semibold">Ausente</span></div>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );

            const renderReportsTab = () => {
                const act = activities.find(a => a.id === selectedActivityForReport);
                let presentCount = 0, absentCount = 0;
                if (act) users.forEach(u => attendance[act.id]?.[u.id] ? presentCount++ : absentCount++);

                return (
                    <div className="space-y-6 pb-20">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h2 className="text-xl font-bold text-slate-800 mb-4">Reporte Global</h2>
                            <select value={selectedActivityForReport} onChange={e => setSelectedActivityForReport(e.target.value)} className="w-full p-3 border border-slate-200 rounded-lg outline-none bg-white focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Selecciona una actividad --</option>
                                {activities.map(a => <option key={a.id} value={a.id}>{a.name} ({a.date})</option>)}
                            </select>
                        </div>
                        {act && (
                            <>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-green-50 p-4 rounded-xl text-center border border-green-100 shadow-sm"><p className="text-sm text-green-600 font-semibold">Presentes</p><p className="text-3xl font-bold text-green-700">{presentCount}</p></div>
                                    <div className="bg-red-50 p-4 rounded-xl text-center border border-red-100 shadow-sm"><p className="text-sm text-red-600 font-semibold">Ausentes</p><p className="text-3xl font-bold text-red-700">{absentCount}</p></div>
                                </div>
                                <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="p-4 bg-slate-50 border-b border-slate-100"><h3 className="font-bold text-slate-700">Detalle de Usuarios</h3></div>
                                    <table className="w-full text-left border-collapse">
                                        <tbody className="divide-y divide-slate-100">
                                            {users.map(user => {
                                                const isPresent = attendance[act.id]?.[user.id] || false;
                                                return (
                                                    <tr key={user.id} className="hover:bg-slate-50">
                                                        <td className="p-3"><p className="font-medium text-slate-800">{user.fullName}</p></td>
                                                        <td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-semibold shadow-sm ${isPresent ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-white text-slate-500 border border-slate-300'}`}>{isPresent ? 'Presente' : 'Ausente'}</span></td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </>
                        )}
                    </div>
                );
            };

            return (
                <div>
                    {renderNotification()}
                    <header className="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10 flex justify-between items-center">
                        <h1 className="text-xl font-bold flex-1 text-center">Control de Asistencia</h1>
                    </header>
                    
                    {!isOnline && (
                        <div className="bg-yellow-50 text-yellow-700 p-2 text-center text-xs font-medium border-b border-yellow-200 flex items-center justify-center">
                            <IconAlertCircle size={16} className="mr-1"/> Modo Offline (Los datos se guardan solo en este celular/PC)
                        </div>
                    )}

                    <main className="p-4 max-w-3xl mx-auto">
                        {activeTab === 'users' && renderUsersTab()}
                        {activeTab === 'activities' && renderActivitiesTab()}
                        {activeTab === 'attendance' && renderAttendanceTab()}
                        {activeTab === 'reports' && renderReportsTab()}
                    </main>
                    <nav className="fixed bottom-0 w-full bg-white border-t border-slate-200 flex justify-around items-center p-2 pb-safe z-20 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
                        <button onClick={() => setActiveTab('users')} className={`flex flex-col items-center p-2 w-full ${activeTab === 'users' ? 'text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}><IconUsers size={24} /><span className="text-[10px] font-medium mt-1">Usuarios</span></button>
                        <button onClick={() => setActiveTab('activities')} className={`flex flex-col items-center p-2 w-full ${activeTab === 'activities' ? 'text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}><IconCalendar size={24} /><span className="text-[10px] font-medium mt-1">Actividades</span></button>
                        <button onClick={() => setActiveTab('attendance')} className={`flex flex-col items-center p-2 w-full ${activeTab === 'attendance' ? 'text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}><IconCheckSquare size={24} /><span className="text-[10px] font-medium mt-1">Asistencia</span></button>
                        <button onClick={() => setActiveTab('reports')} className={`flex flex-col items-center p-2 w-full ${activeTab === 'reports' ? 'text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}><IconFileText size={24} /><span className="text-[10px] font-medium mt-1">Reportes</span></button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>